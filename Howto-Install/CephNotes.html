<OL> 
  <LI> Create Ceph-Temp.img and install the following packages in it:
<PRE>
acl						install
acpi						install
acpi-support-base				install
acpid						install
adduser						install
apt						install
apt-utils					install
aptdaemon					install
aptdaemon-data					install
aptitude					install
aptitude-common					install
base-files					install
base-passwd					install
bash						install
binutils					install
bsdmainutils					install
bsdutils					install
btrfs-tools					install
busybox						install
ca-certificates					install
ceph						install
ceph-common					install
ceph-fuse					install
colord						install
console-setup					install
console-setup-linux				install
consolekit					install
coreutils					install
cpio						install
cron						install
dash						install
dbus						install
dbus-x11					install
dconf-gsettings-backend:amd64			install
dconf-service					install
debconf						install
debconf-i18n					install
debian-archive-keyring				install
debianutils					install
deborphan					install
dialog						install
diffutils					install
discover					install
discover-data					install
dmidecode					install
dmsetup						install
docbook-xml					install
dpkg						install
e2fslibs:amd64					install
e2fsprogs					install
eject						install
emacs						install
emacs23						install
emacs23-bin-common				install
emacs23-common					install
emacsen-common					install
file						install
findutils					install
firmware-linux-free				install
fontconfig					install
fontconfig-config				install
fuse						install
fuse-utils					install
gcc-4.4-base:amd64				install
gcc-4.7-base:amd64				install
gceph						install
gconf-service					install
gconf2						install
gconf2-common					install
gcr						install
gettext-base					install
gir1.2-atk-1.0					install
gir1.2-freedesktop				install
gir1.2-gdkpixbuf-2.0				install
gir1.2-glib-2.0					install
gir1.2-gtk-3.0					install
gir1.2-pango-1.0				install
gir1.2-vte-2.90					install
gksu						install
gnome-keyring					install
gnupg						install
gpgv						install
grep						install
groff-base					install
grub-common					install
grub-pc						install
grub-pc-bin					install
grub2-common					install
gzip						install
hdparm						install
hicolor-icon-theme				install
hostname					install
ifupdown					install
info						install
initramfs-tools					install
initscripts					install
insserv						install
install-info					install
installation-report				install
iproute						install
iptables					install
iputils-ping					install
isc-dhcp-client					install
isc-dhcp-common					install
iso-codes					install
kbd						install
keyboard-configuration				install
klibc-utils					install
kmod						install
krb5-locales					install
laptop-detect					install
libacl1:amd64					install
libaio1:amd64					install
libapt-inst1.5:amd64				install
libapt-pkg4.12:amd64				install
libasound2:amd64				install
libasprintf0c2:amd64				install
libatk1.0-0:amd64				install
libatk1.0-data					install
libatkmm-1.6-1					install
libattr1:amd64					install
libavahi-client3:amd64				install
libavahi-common-data:amd64			install
libavahi-common3:amd64				install
libblkid1:amd64					install
libboost-iostreams1.49.0			install
libbsd0:amd64					install
libbz2-1.0:amd64				install
libc-bin					install
libc6:amd64					install
libcairo-gobject2:amd64				install
libcairo-perl					install
libcairo2:amd64					install
libcairomm-1.0-1				install
libcap-ng0					install
libcap2						install
libcap2-bin					install
libcephfs1					install
libck-connector0:amd64				install
libclass-isa-perl				install
libcolord1:amd64				install
libcomerr2:amd64				install
libcroco3:amd64					install
libcrypto++9					install
libcups2:amd64					install
libcurl3-gnutls:amd64				install
libcwidget3					install
libdatrie1:amd64				install
libdb5.1:amd64					install
libdbus-1-3:amd64				install
libdbus-glib-1-2:amd64				install
libdconf0:amd64					install
libdevmapper1.02.1:amd64			install
libdiscover2					install
libedit2:amd64					install
libept1.4.12					install
libexif12:amd64					install
libexpat1:amd64					install
libffi5:amd64					install
libfile-copy-recursive-perl			install
libfontconfig1:amd64				install
libfreetype6:amd64				install
libfribidi0:amd64				install
libfuse2:amd64					install
libgcc1:amd64					install
libgck-1-0					install
libgconf-2-4:amd64				install
libgconf2-4:amd64				install
libgcr-3-1					install
libgcr-3-common					install
libgcrypt11:amd64				install
libgd2-xpm:amd64				install
libgdbm3:amd64					install
libgdk-pixbuf2.0-0:amd64			install
libgdk-pixbuf2.0-common				install
libgif4						install
libgirepository-1.0-1				install
libgksu2-0					install
libglib-perl					install
libglib2.0-0:amd64				install
libglib2.0-data					install
libglibmm-2.4-1c2a:amd64			install
libgnome-keyring-common				install
libgnome-keyring0:amd64				install
libgnutls26:amd64				install
libgoogle-perftools0				install
libgpg-error0:amd64				install
libgphoto2-2:amd64				install
libgphoto2-l10n					install
libgphoto2-port0:amd64				install
libgpm2:amd64					install
libgssapi-krb5-2:amd64				install
libgtk-3-0:amd64				install
libgtk-3-bin					install
libgtk-3-common					install
libgtk2-perl					install
libgtk2.0-0:amd64				install
libgtk2.0-bin					install
libgtk2.0-common				install
libgtkmm-2.4-1c2a				install
libgtop2-7					install
libgtop2-common					install
libgudev-1.0-0:amd64				install
libgusb2					install
libice6:amd64					install
libidn11:amd64					install
libieee1284-3:amd64				install
libjasper1:amd64				install
libjbig0:amd64					install
libjpeg8:amd64					install
libk5crypto3:amd64				install
libkeyutils1:amd64				install
libklibc					install
libkmod2:amd64					install
libkrb5-3:amd64					install
libkrb5support0:amd64				install
liblcms2-2:amd64				install
libldap-2.4-2:amd64				install
liblocale-gettext-perl				install
liblockfile-bin					install
liblockfile1:amd64				install
libltdl7:amd64					install
liblzma2					install
liblzma5:amd64					install
libm17n-0					install
libmagic1:amd64					install
libmount1					install
libncurses5:amd64				install
libncursesw5:amd64				install
libnewt0.52					install
libnfnetlink0					install
libotf0						install
libp11-kit0:amd64				install
libpam-ck-connector:amd64			install
libpam-gnome-keyring				install
libpam-modules:amd64				install
libpam-modules-bin				install
libpam-runtime					install
libpam0g:amd64					install
libpango-perl					install
libpango1.0-0:amd64				install
libpangomm-1.4-1				install
libpci3:amd64					install
libpcre3:amd64					install
libpipeline1:amd64				install
libpixman-1-0:amd64				install
libpng12-0:amd64				install
libpolkit-agent-1-0:amd64			install
libpolkit-backend-1-0:amd64			install
libpolkit-gobject-1-0:amd64			install
libpopt0:amd64					install
libprocps0:amd64				install
librados2					install
librarian0					install
librbd1						install
libreadline6:amd64				install
librsvg2-2:amd64				install
librsvg2-common:amd64				install
librtmp0:amd64					install
libsane:amd64					install
libsane-common					install
libsane-extras:amd64				install
libsane-extras-common				install
libsasl2-2:amd64				install
libsasl2-modules:amd64				install
libselinux1:amd64				install
libsemanage-common				install
libsemanage1:amd64				install
libsepol1:amd64					install
libsigc++-2.0-0c2a:amd64			install
libslang2:amd64					install
libsm6:amd64					install
libsqlite3-0:amd64				install
libss2:amd64					install
libssh2-1:amd64					install
libssl1.0.0:amd64				install
libstartup-notification0			install
libstdc++6:amd64				install
libswitch-perl					install
libsystemd-login0:amd64				install
libtasn1-3:amd64				install
libtcmalloc-minimal0				install
libtext-charwidth-perl				install
libtext-iconv-perl				install
libtext-wrapi18n-perl				install
libthai-data					install
libthai0:amd64					install
libtiff4:amd64					install
libtinfo5:amd64					install
libudev0:amd64					install
libunwind7					install
libusb-0.1-4:amd64				install
libusb-1.0-0:amd64				install
libustr-1.0-1:amd64				install
libuuid-perl					install
libuuid1:amd64					install
libv4l-0:amd64					install
libv4lconvert0:amd64				install
libvte-2.90-9					install
libvte-2.90-common				install
libvte-common					install
libvte9						install
libwrap0:amd64					install
libx11-6:amd64					install
libx11-data					install
libx11-xcb1:amd64				install
libxapian22					install
libxau6:amd64					install
libxcb-render0:amd64				install
libxcb-shm0:amd64				install
libxcb-util0:amd64				install
libxcb1:amd64					install
libxcomposite1:amd64				install
libxcursor1:amd64				install
libxdamage1:amd64				install
libxdmcp6:amd64					install
libxext6:amd64					install
libxfixes3:amd64				install
libxft2:amd64					install
libxi6:amd64					install
libxinerama1:amd64				install
libxml2:amd64					install
libxmuu1:amd64					install
libxpm4:amd64					install
libxrandr2:amd64				install
libxrender1:amd64				install
libxt6:amd64					install
linux-base					install
linux-image-3.2.0-3-amd64			install
linux-image-amd64				install
locales						install
login						install
logrotate					install
lsb-base					install
lsb-release					install
m17n-contrib					install
m17n-db						install
man-db						install
manpages					install
mawk						install
mime-support					install
module-init-tools				install
mount						install
multiarch-support				install
nano						install
ncurses-base					install
ncurses-bin					install
net-tools					install
netbase						install
netcat-traditional				install
openssh-blacklist				install
openssh-blacklist-extra				install
openssh-client					install
openssh-server					install
openssl						install
os-prober					install
passwd						install
pciutils					install
perl						install
perl-base					install
perl-modules					install
policykit-1					install
powermgmt-base					install
procps						install
psmisc						install
python						install
python-apt					install
python-apt-common				install
python-aptdaemon				install
python-aptdaemon.gtk3widgets			install
python-chardet					install
python-dbus					install
python-dbus-dev					install
python-debian					install
python-defer					install
python-gi					install
python-gnupginterface				install
python-minimal					install
python-pkg-resources				install
python-pycurl					install
python-software-properties			install
python-support					install
python2.6					install
python2.6-minimal				install
python2.7					install
python2.7-minimal				install
rarian-compat					install
readline-common					install
rsyslog						install
sane-utils					install
sed						install
sensible-utils					install
sgml-base					install
sgml-data					install
shared-mime-info				install
software-properties-common			install
software-properties-gtk				install
sudo						install
synaptic					install
sysv-rc						install
sysvinit					install
sysvinit-utils					install
tar						install
tasksel						install
tasksel-data					install
tcpd						install
traceroute					install
ttf-dejavu-core					install
tzdata						install
ucf						install
udev						install
unattended-upgrades				install
update-inetd					install
util-linux					install
vim-common					install
vim-tiny					install
wget						install
whiptail					install
x11-common					install
xauth						install
xkb-data					install
xml-core					install
zlib1g:amd64					install
</PRE>
 <P> As far as I can recall: Resize the image from <code>deb-min</code>, (increased 1G  
to /dev/sda2) and  add <code>sudo</code>, <code>synaptic</code>, <code>emacs</code>, 
<code>ceph</code>.
 <P> Since this VM template is for setting up Cepf Object Storage cluster, it needs 
btrfs and cepf filesystems, automatically load the related modules at boot time.
<PRE>
hsu@Ceph-Temp:~$ diff /etc/modules /etc/modules.orig
8,9d7
< btrfs
< ceph
</PRE>
 <P> Since Ceph is in active development cycle, we need all its newest features 
available, set up sources.list as follow:
<PRE>
hsu@Ceph-Temp:~$ more /etc/apt/sources.list
deb http://140.120.7.21/debian wheezy main contrib
deb http://140.120.7.21/debian sid main contrib
deb http://security.debian.org/ wheezy/updates main contrib
# deb-src http://ftp.tw.debian.org/debian/ squeeze main
</PRE>
<LI> Create 10G empty disk
<PRE>
$ ls -l ../Vdi*/*
-rw-r--r-- 1 hsu hsu 10485760000 Aug 27 14:48 ../Vdisks/blank.ext4
</PRE>
<LI> Modify start-Ceph-Temp-20-efs so that it carries <code>../Vdisks/blank.ext4</code> 
    as /dev/sdb.  Maybe, we need to format <code>blank.ext4</code> to be a btrfs 
    filesystem?  
<PRE>
$ diff start-Ceph-Temp-20-efs start-Ceph-Temp-20-efs.orig
27c27
< kvm -net vde,vlan=0,sock=/src4/ceph/network-3412 -net nic,vlan=0,macaddr=1c:6f:65:85:64:b3 -m 512M -monitor unix:/src4/ceph/network-3412/MonSock,server,nowait -hda ../cluster/Ceph-Temp.img -hdb ../Vdisks/blank.ext4&
---
> kvm -net vde,vlan=0,sock=/src4/ceph/network-3412 -net nic,vlan=0,macaddr=1c:6f:65:85:64:b3 -m 512M -monitor unix:/src4/ceph/network-3412/MonSock,server,nowait -hda ../cluster/Ceph-Temp.img -hdb /dev/sda&
</PRE>
<LI> On the Physical host, install <b>btrfs-tools</b> (via synaptic) so that we can make 
 btrfs filesystem on virtual disk.
<PRE>
 # On Physical Host 
 $ sudo modprobe btrfs 
 $ cat /proc/filesystems | grep btrfs
	btrfs
 $ which mkfs.btrfs  
 $ cd /src4/ceph/Vdisks 
 $ ls -l
total 10240004
-rw-r--r-- 1 hsu hsu 10485760000 Aug 27 14:48 blank.ext4
 $ cp blank.ext4 osdBlk.ada
 $ sudo mkfs.btrfs osdBlk.ada
[sudo] password for hsu: 
WARNING! - Btrfs Btrfs v0.19 IS EXPERIMENTAL
WARNING! - see http://btrfs.wiki.kernel.org before using
fs created label (null) on osdBlk.ada
	nodesize 4096 leafsize 4096 sectorsize 4096 size 9.77GB
Btrfs Btrfs v0.19
 $ sudo mount -t btrfs -o loop osdBlk.ada /mnt/tmp
hsu@amd-6:/src4/ceph/Vdisks$ ls -l /mnt/tmp
total 0
 $ ls -l /dev/disk/by-uuid | grep loop
lrwxrwxrwx 1 root root 11 Aug 29 18:49 844d814e-2467-4072-8f10-98cb19d3273b -> ../../loop0 
 $ cat /etc/mtab | grep /mnt/tmp
/dev/loop0 /mnt/tmp btrfs rw,relatime,space_cache 0 0
 # Similarly, we copy blank.ext4 to osdBlk.bob and osdBlk.cay.  Then, we make btrfs on 
 # each of them and check their UUIDs as above.  Make sure the UUIDs of all of them are
 # different.
 $ pwd
/src4/ceph/Vdisks
 $ ls -l
total 40960016
-rw-r--r-- 1 hsu hsu 10485760000 Aug 27 14:48 blank.ext4
-rw-r--r-- 1 hsu hsu 10485760000 Aug 29 18:56 osdBlk.ada
-rw-r--r-- 1 hsu hsu 10485760000 Aug 29 22:33 osdBlk.bob
-rw-r--r-- 1 hsu hsu 10485760000 Aug 29 22:34 osdBlk.cay
 $ file osdBlk.ada
osdBlk.ada: BTRFS Filesystem sectorsize 4096, nodesize 4096, leafsize 4096)
 $ file osdBlk.bob
osdBlk.bob: BTRFS Filesystem sectorsize 4096, nodesize 4096, leafsize 4096)
 $ file osdBlk.cay
osdBlk.cay: BTRFS Filesystem sectorsize 4096, nodesize 4096, leafsize 4096)
</PRE>
<LI> Prepare the needed Data or Configuration Files:
<PRE>
hsu@amd-6:/src4/ceph/DataFiles$ pwd
/src4/ceph/DataFiles
hsu@amd-6:/src4/ceph/DataFiles$ ls -l
total 8
-rw-r--r-- 1 hsu hsu 893 Sep  1 09:41 ceph.conf
-rw-r--r-- 1 hsu hsu 146 Sep  3 09:10 ceph.hosts
lrwxrwxrwx 1 hsu hsu  10 Sep  3 09:09 hosts -> ceph.hosts
hsu@amd-6:/src4/ceph/DataFiles$ cat ceph.hosts
192.168.0.5      Ceph-Temp     ceph-temp
192.168.0.6      Ada           ada
192.168.0.7      Bob           bob
192.168.0.8      Cay           cay
hsu@amd-6:/src4/ceph/DataFiles$ cat ceph.conf
# Omit lengthy output
</PRE>
<LI> Boot Ceph-Temp
<OL>
  <LI> Permit Root login so that <b>mkcephfs</b> can be executed as root.
<PRE>
hsu@Ceph-Temp:~$ diff /etc/ssh/sshd_config /etc/ssh/sshd_config.bkp
26c26
< PermitRootLogin yes
---
> PermitRootLogin no
</PRE>
<P> Remember to turn off the RootLogin permission for ceph-temp after 
  ada, bob, and cay are ready.
  <LI> scp DataFiles/ceph.conf to 192.168.0.5:/tmp and
<PRE>
hsu@Ceph-Temp:~$ sudo mv /tmp/ceph.conf /etc/ceph
</PRE>
  <LI> The necessary directories <code>/srv/ceph</code>, <code>/srv/ceph/mon</code>,
 <code>/srv/ceph/osd</code>, <code>/srv/ceph/osd/osd.ada</code> in <code>/srv</code>
 are created in the Config-Kvm-Storage script.  And the next line for mounting 
 (btrfs) object storage is added to /etc/rc.local.
<PRE>
 mount -t btrfs /dev/sdb /srv/ceph/osd/osd.ada
</PRE>
  <P> Also, the <code>DataFiles/ceph.hosts</code> is symbolic linked to 
<code>DataFiles/hosts</code>.  From <code>DataFiles/hosts</code>, 
Config-Kvm-Storage script will append it to newly generated <code>/etc/hosts</code>.
  <LI> Produce ada, bob, cay VMs
<PRE> 
 $ cd /src4/ceph/cluster 
 $ cp Ceph-Temp.img Ceph-Ada.img
 $ cd ../bin 
 $ Config-Kvm-Storage ../cluster/Ceph-Ada.img Ada 192.168.0.6 eth0 21  ../Vdisks/osdBlk.ada
</PRE>
<P> Do the same for bob, cay.  Then boot all of them in the foreground and 
  execute <code>$ sudo ./recover70rules</code> on all of them to get rid of 
  eth1, the wrong ethernet device.
  <LI> <a href="http://ceph.com/wiki/Creating_a_new_file_system" 
     target="newwindow">Generate SSH key for root</a>
<P> We need to set up ssh keys so that the machine we are running mkcephfs on 
(master) can ssh in to other nodes (slave) as root.   We do this as follows:
<P> <b>ssh-keygen</b> does not recognize the "-d" option!
<PRE>
 $ ssh -X root@192.168.0.8
Cay:~# ssh-keygen 
Generating public/private rsa key pair.
Enter file in which to save the key (/root/.ssh/id_rsa): 
Created directory '/root/.ssh'.
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /root/.ssh/id_rsa.
Your public key has been saved in /root/.ssh/id_rsa.pub.
The key fingerprint is:
54:e6:a7:36:60:5d:f4:8b:d3:0a:04:a9:3c:78:2e:7e root@Cay
The key's randomart image is:
+--[ RSA 2048]----+
|        ..o.o    |
|        .* . .   |
|     o .+ + . .  |
|    . =o o o o . |
|     o .S = o o  |
|    . .  . o o   |
|   . .      .    |
|    . E          |
|     .           |
+-----------------+
Cay:~# ssh-copy-id root@bob
Cay:~# ssh-copy-id root@ada
</PRE>
</OL>
<LI> <a href="http://ceph.com/wiki/Creating_a_new_file_system" 
target="newwindow"><b>mkcephfs</b></a> --- create a new Ceph cluster file system
<P> The formal names for our VMs are: Ada, Bob, Cay.  Nicknames are ada, bob, cay. 
Unfortunately, in <code>/etc/ceph/ceph.conf</code> file, we use their nicknames 
when assigning host values.  We correct it after the execution of <b>mkcephfs</b> 
failed.  Then tried it again.
<PRE>
Cay:~# mkcephfs -c /etc/ceph/ceph.conf -a -k /etc/ceph/keyring.admin
temp dir is /tmp/mkcephfs.AhJuMn5xlH
preparing monmap in /tmp/mkcephfs.AhJuMn5xlH/monmap
/usr/bin/monmaptool --create --clobber --add a 192.168.0.6:6789 --add b 192.168.0.7:6789 --add c 192.168.0.8:6789 --print /tmp/mkcephfs.AhJuMn5xlH/monmap
/usr/bin/monmaptool: monmap file /tmp/mkcephfs.AhJuMn5xlH/monmap
/usr/bin/monmaptool: generated fsid bcf49709-ae94-4244-b4a9-21b481288a8e
epoch 0
fsid bcf49709-ae94-4244-b4a9-21b481288a8e
last_changed 2012-09-03 18:45:26.667257
created 2012-09-03 18:45:26.667257
0: 192.168.0.6:6789/0 mon.a
1: 192.168.0.7:6789/0 mon.b
2: 192.168.0.8:6789/0 mon.c
/usr/bin/monmaptool: writing epoch 0 to /tmp/mkcephfs.AhJuMn5xlH/monmap (3 monitors)
=== osd.0 === 
pushing conf and monmap to Ada:/tmp/mkfs.ceph.2144
2012-09-03 18:45:29.545637 7fde12bbd780 -1 filestore(/srv/ceph/osd/osd.Ada) could not find 23c2fcde/osd_superblock/0//-1 in index: (2) No such file or directory
2012-09-03 18:45:30.162704 7fde12bbd780 -1 created object store /srv/ceph/osd/osd.Ada journal /srv/ceph/osd/osd.0.journal for osd.0 fsid bcf49709-ae94-4244-b4a9-21b481288a8e
creating private key for osd.0 keyring /etc/ceph/keyring.osd.0
creating /etc/ceph/keyring.osd.0
collecting osd.0 key
=== osd.1 === 
pushing conf and monmap to Bob:/tmp/mkfs.ceph.2144
2012-09-03 18:45:32.790829 7fde309ac780 -1 filestore(/srv/ceph/osd/osd.Bob) could not find 23c2fcde/osd_superblock/0//-1 in index: (2) No such file or directory
2012-09-03 18:45:33.384811 7fde309ac780 -1 created object store /srv/ceph/osd/osd.Bob journal /srv/ceph/osd/osd.1.journal for osd.1 fsid bcf49709-ae94-4244-b4a9-21b481288a8e
creating private key for osd.1 keyring /etc/ceph/keyring.osd.1
creating /etc/ceph/keyring.osd.1
collecting osd.1 key
=== osd.2 === 
2012-09-03 18:45:33.983906 7f474305a780 -1 filestore(/srv/ceph/osd/osd.Cay) could not find 23c2fcde/osd_superblock/0//-1 in index: (2) No such file or directory
2012-09-03 18:45:34.594248 7f474305a780 -1 created object store /srv/ceph/osd/osd.Cay journal /srv/ceph/osd/osd.2.journal for osd.2 fsid bcf49709-ae94-4244-b4a9-21b481288a8e
creating private key for osd.2 keyring /etc/ceph/keyring.osd.2
creating /etc/ceph/keyring.osd.2
=== mds.a === 
pushing conf and monmap to Ada:/tmp/mkfs.ceph.2144
creating private key for mds.a keyring /etc/ceph/keyring.mds.a
creating /etc/ceph/keyring.mds.a
collecting mds.a key
=== mds.c === 
creating private key for mds.c keyring /etc/ceph/keyring.mds.c
creating /etc/ceph/keyring.mds.c
Building generic osdmap from /tmp/mkcephfs.AhJuMn5xlH/conf
/usr/bin/osdmaptool: osdmap file '/tmp/mkcephfs.AhJuMn5xlH/osdmap'
/usr/bin/osdmaptool: writing epoch 1 to /tmp/mkcephfs.AhJuMn5xlH/osdmap
Generating admin key at /tmp/mkcephfs.AhJuMn5xlH/keyring.admin
creating /tmp/mkcephfs.AhJuMn5xlH/keyring.admin
Building initial monitor keyring
added entity mds.a auth auth(auid = 18446744073709551615 key=AQBQikRQoE2WCBAA4Ok+m3gHjepnuITEx7rBrw== with 0 caps)
added entity mds.c auth auth(auid = 18446744073709551615 key=AQBPikRQaOdRIhAAgQ2NBgtqeg9p0uwwUUegtQ== with 0 caps)
added entity osd.0 auth auth(auid = 18446744073709551615 key=AQBKikRQsHT1DRAAgOIDa2aS/B+l6KC1qVlVYw== with 0 caps)
added entity osd.1 auth auth(auid = 18446744073709551615 key=AQBNikRQQBAiGhAAYRaqXLi64pO4Ea5bXW6m6g== with 0 caps)
added entity osd.2 auth auth(auid = 18446744073709551615 key=AQBOikRQiGsxJhAAMLlE76RrGZkXzyAu8XiNTA== with 0 caps)
=== mon.a === 
pushing everything to Ada
/usr/bin/ceph-mon: created monfs at /srv/ceph/mon/mon.a for mon.a
=== mon.b === 
pushing everything to Bob
/usr/bin/ceph-mon: created monfs at /srv/ceph/mon/mon.b for mon.b
=== mon.c === 
/usr/bin/ceph-mon: created monfs at /srv/ceph/mon/mon.c for mon.c
placing client.admin keyring in /etc/ceph/keyring.admin
Cay:~# echo $?
0
</PRE>
<P> Carefully examine ada, bob, and cay, only cay, the one on which we execute the 
<b>mkcephfs</b> command, has <code>/etc/ceph/keyring.admin</code>
<PRE>
Cay:~$ su root
Password: 
root@Cay:/home/hsu# for host in ada bob
>                     do
>                       scp /etc/ceph/keyring.admin root@$host:/etc/ceph/keyring.admin;
>                     done
keyring.admin                                 100%   63     0.1KB/s   00:00    
keyring.admin                                 100%   63     0.1KB/s   00:00    
</PRE>
<LI> Deploying with mkcephfs 
<a href="http://ceph.com/docs/master/config-cluster/mkcephfs/"
  target="newwindow">(Source Origin)</a>
<h5>Enabling Authentication</h5>
<p>In the <tt class="docutils literal"><span class="pre">[global]</span></tt> settings 
of your <tt class="docutils literal"><span class="pre">ceph.conf</span></tt> file, you 
can enable authentication for your cluster.</p>
<div><pre>[global]
        auth supported = cephx</pre>
</div>
<p>The valid values are <code>cephx</code> or <code>none</code>. If you specify 
<code>cephx</code>, Ceph will look for the keyring in the default search path, which
includes <code>/etc/ceph/keyring</code>.  You can override this location by
adding a <b>keyring</b> option in the <code>[global]</code> section of your
<b>ceph.conf</b> file, but this is not recommended.</p>
</div>
<div class="section" id="the-client-admin-key">
<P> For authentication business, please check its official documentation: 
<a href="http://ceph.com/wiki/Cephx"
  target="newwindow">Cephx</a> and 
<a href="http://ceph.com/docs/master/cluster-ops/authentication/"
  target="newwindow">Authentication</a>.  You may also login ceph-enabled 
VM and check its manual page via
<PRE>
hsu@Ceph-Temp:~$ man ceph-authtool 
CEPH-AUTHTOOL(8)                     Ceph                     CEPH-AUTHTOOL(8)
NAME
       ceph-authtool - ceph keyring manipulation tool
SYNOPSIS
       ceph-authtool keyringfile [ -l | --list ] [ -C | --create-keyring
       ] [ -p | --print ] [ -n | --name entityname ] [ --gen-key ] [ -a |
       --add-key base64_key ] [ --caps capfils ]
     .
     .
     .
</PRE>
<LI> Ceph Clients
<P> First, login ada, bob, and cay, as root, start ceph.  Probably, we should put 
   this line in <code>/etc/rc.local</code>.
<PRE>
 # /etc/init.d/ceph start
</PRE>
<P> Now, are we ready to use our storage cluster yet? For reference:
<a href="http://ceph.com/wiki/Mounting_the_file_system"
target="newwindow">Mounting Ceph FS</a>
<P> <b>Warning: Don't mount ceph using kernel driver on the osd server. Perhaps it 
will freeze the ceph client and your osd server. </b>
<PRE>
hsu@amd-6:/src4/ceph$ cp cluster/Ceph-Temp.img clients/Ceph-Client.img
hsu@amd-6:/src4/ceph$ cd bin
$ ./Config-Kvm ../clients/Ceph-Client.img ceph-client1 192.168.0.130 eth0 30
# Ada, Bob, Cay are already online
hsu@amd-6:/src4/ceph/bin$ start-ceph-client1-30
hsu@amd-6:~$ ssh -X hsu@192.168.0.130
$ sudo ceph-authtool -l /etc/ceph/keyring.admin
[sudo] password for hsu: 
can't open /etc/ceph/keyring.admin: can't open /etc/ceph/keyring.admin: (2) No such file or directory
ceph-client1:~$ which ceph-fuse
/usr/bin/ceph-fuse
ceph-client1:~$ ceph-fuse -m 192.168.0.6:6789 /mnt/tmp
# Failed due to: auth: failed to open keyring from /etc/ceph/keyring.admin
</PRE>
<P> We need to get the <code>/etc/ceph/keyring.admin</code> from ada, bob, or cay.
<PRE>
ceph-client1:~$ ceph-authtool -l /etc/ceph/keyring.admin
[client.admin]
	key = AQBPikRQiDwkJhAAMjbxXa5fkivW09yCVbvZvw==
ceph-client1:~$  ceph -s
   health HEALTH_OK
   monmap e1: 3 mons at {a=192.168.0.6:6789/0,b=192.168.0.7:6789/0,c=192.168.0.8:6789/0}, election epoch 6, quorum 0,1,2 a,b,c
   osdmap e7: 3 osds: 3 up, 3 in
    pgmap v232: 576 pgs: 576 active+clean; 8730 bytes data, 8384 KB used, 26915 MB / 30000 MB avail
   mdsmap e5: 1/1/1 up {0=c=up:active}, 1 up:standby
# Next command need to be executed with sudo.  Otherwise, failed to open /dev/fuse
ceph-client1:~$ ls -l /dev/fuse
ceph-client1:~$ sudo ceph-fuse -m 192.168.0.6:6789 /mnt/tmp
ceph-fuse[2361]: starting ceph client
ceph-fuse[2361]: starting fuse
ceph-client1:~$ ls -l /mnt/tmp
total 0
ceph-client1:~$ sudo umount /mnt/tmp
ceph-client1:~$ sudo mount -t ceph 192.168.0.6:6789:/ /mnt/tmp -vv -o name=admin,secret=AQBPikRQiDwkJhAAMjbxXa5fkivW09yCVbvZvw==
parsing options: rw,name=admin,secret=AQBPikRQiDwkJhAAMjbxXa5fkivW09yCVbvZvw==
mount: error writing /etc/mtab: Invalid argument
# Although we got the last error message line, it seems ceph filesystem is ready and 
# been mounted on the /mnt/tmp directory.  It even shows up in <code>/etc/mtab</code>.
ceph-client1:~$ ls -lia /mnt/tmp
total 4
   1 drwxr-xr-x 1 root root    0 Sep  7 15:19 .
7689 drwxr-xr-x 3 root root 4096 Sep  7 10:13 ..
ceph-client1:~$ df
Filesystem         1K-blocks    Used Available Use% Mounted on
rootfs               2615208  996020   1488120  41% /
udev                   10240       0     10240   0% /dev
tmpfs                  50900     156     50744   1% /run
/dev/sda2            2615208  996020   1488120  41% /
tmpfs                   5120       0      5120   0% /run/lock
tmpfs                 101780       0    101780   0% /run/shm
/dev/sda1             467367   19636    422797   5% /boot
192.168.0.6:6789:/  30720000 3159040  27560960  11% /mnt/tmp
ceph-client1:~$ cat /etc/mtab
rootfs / rootfs rw 0 0
sysfs /sys sysfs rw,nosuid,nodev,noexec,relatime 0 0
proc /proc proc rw,nosuid,nodev,noexec,relatime 0 0
udev /dev devtmpfs rw,relatime,size=10240k,nr_inodes=62132,mode=755 0 0
devpts /dev/pts devpts rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000 0 0
tmpfs /run tmpfs rw,nosuid,noexec,relatime,size=50900k,mode=755 0 0
/dev/sda2 / ext4 rw,relatime,errors=remount-ro,user_xattr,acl,barrier=1,data=ordered 0 0
tmpfs /run/lock tmpfs rw,nosuid,nodev,noexec,relatime,size=5120k 0 0
tmpfs /run/shm tmpfs rw,nosuid,nodev,noexec,relatime,size=101780k 0 0
fusectl /sys/fs/fuse/connections fusectl rw,relatime 0 0
/dev/sda1 /boot ext2 rw,relatime,errors=continue 0 0
192.168.0.6:6789:/ /mnt/tmp ceph rw,relatime,name=admin,secret=<hidden> 0 0
</PRE>
  <LI> <a href="http://ceph.com/wiki/Rbd" target="newwindow">Rbd: Rados block 
   device</a>
<P> Booting ceph cluster and ceph-client and check its health:
<PRE>
hsu@amd-6:/src4/ceph/bin$ start-Ada-21-AsDaemon; start-Bob-22-AsDaemon; start-Cay-23-AsDaemon; start-ceph-client1-30-AsDaemon
hsu@amd-6:~$ ssh -X hsu@192.168.0.130
hsu@192.168.0.130's password: 
Linux ceph-client1 3.2.0-3-amd64 #1 SMP Mon Jul 23 02:45:17 UTC 2012 x86_64
The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.
Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Sun Sep  9 15:26:12 2012 from 192.168.0.32
ceph-client1:~$ ceph -s
   health HEALTH_OK
   monmap e1: 3 mons at {a=192.168.0.6:6789/0,b=192.168.0.7:6789/0,c=192.168.0.8:6789/0}, election epoch 2, quorum 0,1,2 a,b,c
   osdmap e29: 3 osds: 3 up, 3 in
    pgmap v607: 576 pgs: 576 active+clean; 9947 bytes data, 9084 KB used, 26915 MB / 30000 MB avail
   mdsmap e19: 1/1/1 up {0=c=up:active}, 1 up:standby
ceph-client1:~$ 
</PRE>
<P> On the ceph server, create rbd image and resize it:
<PRE>
$ xs cay
Cay:~$ sudo rbd create foo --size 256
Cay:~$ sudo rbd list
foo
Cay:~$ sudo rbd resize --image foo --size 512
Resizing image: 100% complete...done.
Cay:~$ sudo rbd info foo
rbd image 'foo':
	size 512 MB in 128 objects
	order 22 (4096 KB objects)
	block_name_prefix: rb.0.0
	parent:  (pool -1)
Cay:~$ sudo rados ls -p rbd
foo.rbd
rbd_directory
rbd_info
# Remember issue the following command to delete foo after we have done with client side.
Cay:~$ sudo  rbd rm foo
Removing image: 100% complete...done.
Cay:~$  sudo rbd list
</PRE>
<P> On the ceph client side, 
<PRE>
ceph-client1:~$ ceph-authtool -l /etc/ceph/keyring.admin
[client.admin]
	key = AQBPikRQiDwkJhAAMjbxXa5fkivW09yCVbvZvw==
ceph-client1:~$ echo "AQBPikRQiDwkJhAAMjbxXa5fkivW09yCVbvZvw==" >/tmp/secretfile 
ceph-client1:~$ more /tmp/secretfile
AQBPikRQiDwkJhAAMjbxXa5fkivW09yCVbvZvw==
ceph-client1:~$ lsmod | grep rbd
ceph-client1:~$ sudo modprobe rbd
[sudo] password for hsu: 
ceph-client1:~$ lsmod | grep rbd
rbd                    22311  0 
libceph                90118  2 ceph,rbd
ceph-client1:~$ ls -l /sys/bus/rbd
total 0
--w------- 1 root root 4096 Sep 10 09:14 add
drwxr-xr-x 2 root root    0 Sep 10 09:14 devices
drwxr-xr-x 2 root root    0 Sep 10 09:14 drivers
-rw-r--r-- 1 root root 4096 Sep 10 09:14 drivers_autoprobe
--w------- 1 root root 4096 Sep 10 09:14 drivers_probe
--w------- 1 root root 4096 Sep 10 09:14 remove
--w------- 1 root root 4096 Sep 10 09:14 uevent
$ sudo echo "192.168.0.6,192.168.0.7,192.168.0.8 name=admin,secret=`cat /tmp/secretfile` rbd foo" >/sys/bus/rbd/add
-bash: /sys/bus/rbd/add: Permission denied
ceph-client1:~$ su
Password: 
root@ceph-client1:/home/hsu# echo "192.168.0.6,192.168.0.7,192.168.0.8 name=admin,secret=`cat /tmp/secretfile` rbd foo" >/sys/bus/rbd/add
root@ceph-client1:/home/hsu# ls /sys/bus/rbd/devices
0
root@ceph-client1:/home/hsu# ls -l /sys/bus/rbd/devices
total 0
lrwxrwxrwx 1 root root 0 Sep 10 09:31 0 -> ../../../devices/rbd/0
root@ceph-client1:/home/hsu# ls -l /sys/devices/rbd/0
total 0
-r--r--r-- 1 root root 4096 Sep 10 09:33 client_id
--w------- 1 root root 4096 Sep 10 09:33 create_snap
-r--r--r-- 1 root root 4096 Sep 10 09:20 current_snap
-r--r--r-- 1 root root 4096 Sep 10 09:33 major
-r--r--r-- 1 root root 4096 Sep 10 09:20 name
-r--r--r-- 1 root root 4096 Sep 10 09:20 pool
drwxr-xr-x 2 root root    0 Sep 10 09:33 power
--w------- 1 root root 4096 Sep 10 09:33 refresh
-r--r--r-- 1 root root 4096 Sep 10 09:33 size
lrwxrwxrwx 1 root root    0 Sep 10 09:20 subsystem -> ../../../bus/rbd
-rw-r--r-- 1 root root 4096 Sep 10 09:20 uevent
root@ceph-client1:/home/hsu# cat /sys/devices/rbd/0/size
536870912
root@ceph-client1:/home/hsu# ls -l /dev/rbd0
brw-rw---T 1 root disk 254, 0 Sep 10 09:20 /dev/rbd0
root@ceph-client1:/home/hsu# cat /sys/devices/rbd/0/client_id
client4705
root@ceph-client1:/home/hsu# cat /sys/devices/rbd/0/name
foo
root@ceph-client1:/home/hsu# mkfs -t ext2 /dev/rbd0
mke2fs 1.42.5 (29-Jul-2012)
Filesystem label=
OS type: Linux
Block size=4096 (log=2)
Fragment size=4096 (log=2)
Stride=1024 blocks, Stripe width=1024 blocks
32768 inodes, 131072 blocks
6553 blocks (5.00%) reserved for the super user
First data block=0
Maximum filesystem blocks=134217728
4 block groups
32768 blocks per group, 32768 fragments per group
8192 inodes per group
Superblock backups stored on blocks: 
	32768, 98304
Allocating group tables: done                            
Writing inode tables: done                            
Writing superblocks and filesystem accounting information: done
root@ceph-client1:/home/hsu# mount -t ext2 /dev/rbd0 /mnt
root@ceph-client1:/home/hsu# ls -l /mnt
total 16
drwx------ 2 root root 16384 Sep 10 09:48 lost+found
root@ceph-client1:/home/hsu# df /mnt
Filesystem     1K-blocks  Used Available Use% Mounted on
/dev/rbd0         516040   396    489432   1% /mnt
root@ceph-client1:/home/hsu# more /etc/mtab
rootfs / rootfs rw 0 0
sysfs /sys sysfs rw,nosuid,nodev,noexec,relatime 0 0
proc /proc proc rw,nosuid,nodev,noexec,relatime 0 0
udev /dev devtmpfs rw,relatime,size=10240k,nr_inodes=62132,mode=755 0 0
devpts /dev/pts devpts rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000 0 0
tmpfs /run tmpfs rw,nosuid,noexec,relatime,size=50900k,mode=755 0 0
/dev/sda2 / ext4 rw,relatime,errors=remount-ro,user_xattr,acl,barrier=1,data=ord
ered 0 0
tmpfs /run/lock tmpfs rw,nosuid,nodev,noexec,relatime,size=5120k 0 0
tmpfs /run/shm tmpfs rw,nosuid,nodev,noexec,relatime,size=101780k 0 0
fusectl /sys/fs/fuse/connections fusectl rw,relatime 0 0
/dev/sda1 /boot ext2 rw,relatime,errors=continue 0 0
/dev/rbd0 /mnt ext2 rw,relatime,errors=continue,user_xattr,acl 0 0
root@ceph-client1:/home/hsu# umount /mnt
root@ceph-client1:/home/hsu# echo 0 > /sys/bus/rbd/remove
root@ceph-client1:/home/hsu# ls -l  /dev/rbd0
ls: cannot access /dev/rbd0: No such file or directory
root@ceph-client1:/home/hsu# ls -l /sys/bus/rbd/devices
total 0
root@ceph-client1:/home/hsu#  ls -l /sys/devices/rbd
total 0
drwxr-xr-x 2 root root    0 Sep 10 09:57 power
-rw-r--r-- 1 root root 4096 Sep 10 09:20 uevent
</PRE>
<LI> An rbd can not be shared by multiple VMs, (need to verify this statement.)  
   For it to be shared by multiple VMs, we need to export it via <b>iSCSI</b>. 
   With <b>iSCSI</b>, we can provide redundancy via multipathing, but we need 
   different subnets (and router between subnets).  Roughly speaking, 
   <b>iSCSI multipath</b> is to provide two or more IP paths for accessing an 
   iSCSI connected block storage device.  And this two IP paths must come 
   from two different subnets, so that if one subnet failed, there is another 
   IP path to reach this block storage.  Also, theoretically, the internet 
   bandwidth can be increased, especially, if second IP path can be set up 
   on GB ether devices.
<P> <b>More subtle problem:</b> 
<a href="http://comments.gmane.org/gmane.comp.file-systems.ceph.devel/4596" 
target="newwindow">rbd device would disappear after re-boot</a>
<LI> Router/Gateway
<P> <b>Note: (10/08/2012)</b> MyRouter is OK, I think.  To test it, bring up Test-Eth1 
(on ac00), a VM with only IP 192.168.1.254, edit its /etc/rc.local so that its default 
gateway is 192.168.1.1, not 192.168.1.33, the second IP address of ac00.  Reboot it.  
And on amd-6, booting MyRouter and ceph-client1.  Login Test-Eth1, from it we can 
successfully login 192.168.0.33, 192.168.0.32, 192.168.0.130 (ceph-client1), but 
not machines on the 140.120 network.  But, I think this is OK, since 192.168.1.0/24 
is our own private lan.  (Originally, Test-Eth1 with 192.168.1.33 default gateway 
can reach anywhere.)
<P> <b>Note: (10/08/2012)</b> Our router should route 192.168.1.0/24 subnet to other 
subnet.  For consistency, we use eth1 (if possible at all, for virtual machines 
with only one 192.168.1.* IP address, it only has (virtual) eth0 card,) to connect 
our 192.168.1.0/24 subnet.  For Setting up Kvm with 2 Nics and 2 Taps, you may 
consult the <a href="#KvmWith2Nics">Kvm with 2 Nics</a>. The correct way to setup 
MyRouter is as follows:
<PRE>
 $ Config-Kvm ../Router/MyRouter.img MyRouter 192.168.1.1 eth1 13 
 # Edit start-MyRouter-13, start-MyRouter-13-AsDaemon, stop-MyRouter-restore-lan-13 
 # As follows:
 $ diff start-MyRouter-13  start-MyRouter-13.orig
17,22d16
< ################################################################################
< sudo tunctl -u hsu -t tap103
< sudo ifconfig tap103 192.168.0.32 netmask 255.255.255.255 up
< sudo iptables --table nat -A POSTROUTING --out-interface eth0 -j MASQUERADE
< sudo iptables -A FORWARD --in-interface tap103 -j ACCEPT
< ################################################################################
28,32d21
< ################################################################################
< sudo sysctl net.ipv4.conf.tap103.proxy_arp=1
< sudo arp -Ds 192.168.0.2 eth0 pub
< sudo route add -host 192.168.0.2 dev tap103
< ################################################################################
35,37d23
< ################################################################################
< vde_switch -tap tap103 -mod 644 -sock=/src4/ceph/network-3039 -mgmt /src4/ceph/network-3039/vde_switch.mgmt -daemon </dev/null >/dev/null
< ################################################################################
39,43c25
< ################################################################################
< # The MAC addresses for eth0 and eth1 are inscribed in config.boot file, can't be 
< # changed arbitrarily.
< ################################################################################
< kvm -net vde,vlan=0,sock=/src4/ceph/network-3039 -net nic,vlan=0,macaddr=1c:6f:65:4f:cc:8f -net vde,vlan=1,sock=/src4/ceph/network-3049  -net nic,vlan=1,macaddr=1c:6f:65:e5:2f:3d -m 512M -monitor unix:/src4/ceph/network-3049/MonSock,server,nowait -hda ../Router/MyRouter.img &
---
> kvm -net vde,vlan=0,sock=/src4/ceph/network-3049 -net nic,vlan=0,macaddr=1c:6f:65:e5:2f:3d -net nic,vlan=0,macaddr=1c:6f:65:4f:cc:8f -m 512M -monitor unix:/src4/ceph/network-3049/MonSock,server,nowait -hda ../Router/MyRouter.img &
 ############################################################################
 # For start-MyRouter-13-AsDaemon script, it is almost identical to start-MyRouter-13,
 # We only need to pay attention to the "-net" options for the kvm command.  And the 
 # eth0 and eth1 MAC addresses are hard-coded in its /opt/vyatta/etc/config/config.boot 
 # file.   We also use vlan0 and vlan1 as different (virtual) switches for two different
 # subnets.  It seems OK, now.   Surely, we need more testing!!  The difference of the 
 # last line in the start-MyRouter-13-AsDaemon and start-MyRouter-13-AsDaemon.orig shell
 # scripts is kept, the rest differences are the same as above.
 ############################################################################
< screen -S MyRouter -d -m kvm  -net vde,vlan=0,sock=/src4/ceph/network-3039 -net nic,vlan=0,macaddr=1c:6f:65:4f:cc:8f -net vde,vlan=1,sock=/src4/ceph/network-3049  -net nic,vlan=1,macaddr=1c:6f:65:e5:2f:3d  -m 512M -monitor unix:/src4/ceph/network-3049/MonSock,server,nowait -curses -hda ../Router/MyRouter.img &
---
> screen -S MyRouter -d -m kvm -net vde,vlan=0,sock=/src4/ceph/network-3049 -net nic,vlan=0,macaddr=1c:6f:65:e5:2f:3d -net nic,vlan=0,macaddr=1c:6f:65:4f:cc:8f -m 512M -monitor unix:/src4/ceph/network-3049/MonSock,server,nowait -curses -hda ../Router/MyRouter.img &
$ diff stop-MyRouter-restore-lan-13 stop-MyRouter-restore-lan-13.orig
45,47d44
< ################################################################################
< sudo pkill -f "vde_switch -tap tap103 -mod 644 -sock=/src4/ceph/network-3039 -mgmt /src4/ceph/network-3039/vde_switch.mgmt"
< ################################################################################
52,56d48
< ################################################################################
< if [ -S /src4/ceph/network-3039/ctl ]; then rm /src4/ceph/network-3039/ctl; fi
< if [ -S /src4/ceph/network-3039/vde_switch.mgmt ]; then rm /src4/ceph/network-3039/vde_switch.mgmt; fi
< if [ -d /src4/ceph/network-3039 ]; then rm -rf /src4/ceph/network-3039; fi
< ################################################################################
65,71d56
< ################################################################################
< sudo sysctl net.ipv4.conf.tap103.proxy_arp=0
< sudo ifconfig tap103 192.168.0.32 down
< # sudo iptables --table nat -D POSTROUTING --out-interface eth1 -j MASQUERADE
< sudo iptables -D FORWARD --in-interface tap103 -j ACCEPT
< sudo tunctl -d tap103
< ################################################################################
</PRE>
<P> <b>Note: (09/28/2012)</b> <a href="http://en.wikipedia.org/wiki/Vyatta" 
target="newwindow">Vyatta</a>, a Debian-based software-based virtual router, and 
claimed to be similar to Juniper JUNOS or Cisco IOS. It has two editions: (1) 
subscription and (2) open sourced editions.  Subscription edition provides web-based 
management interface, i.e. user friendlier.  We take the second approach.  Almost all 
the setups you did based on your Debian experience are in vain, i.e. after rebooting, 
setups are gone.  Only can be done via <b>configure</b>, a command no where to be 
located.  Worst of all, you won't be able to upgrade your software packages using 
Debian mirror.  And you can't install additional packages, such as synaptic and emacs.  
<b>nano</b> is the only text editor (similar to emacs) available.  There is no X GUI 
interface, everything is based on command line interface (CLI).  Its documentaion, 
<a href="http://www.vyatta.com/download/documentation" target="newwindow">Vyatta 
Doc</a>, can be downloaded, but one must register first, how unuser-friendly it is.
<P> We need a router/gateway. Try to use <a href="http://en.wikipedia.org/wiki/Vyatta" 
target=newwindow">Vyatta Router</a>.  Download its iso from 
<a href="http://packages.vyatta.com/vyatta/iso/VC6.4/" 
target=newwindow">vyatta-livecd-virt_VC6.4-2012.05.31_amd64.iso</a>  When booting 
vyatta for kvm-image installation, we need to use the 
<a href="http://www.thegeekstuff.com/2011/09/parted-command-examples/" 
target="newwindow">gparted command</a> to partition the image.
<PRE>
 $ mkdir /src4/ceph/Router
 $ mv *iso /src4/ceph/Router
 $ cd /src4/ceph/Router
 $ qemu-img create MyRouter.img 4G
 $ kvm -no-kvm -cdrom vyatta-livecd-virt_VC6.4-2012.05.31_amd64.iso -hda MyRouter.img -boot d
</PRE>
<P> When asking for partitioning hard disk, choose gparted:
<PRE>
 # When seeing system prompt, type "install system" without the double quotes.
 # print ;; print info about hard disk.
 # mkpartfs primary ext2 1 512  ;; in the unit of MBs.
 # set 1 boot on ;; enable boot option on partition 1.
 # print
 # mkpartfs primary ext4 512 
</PRE>
<P> The above commands all end up /dev/sda unrecognized disk label.  We can use 
<b>start-Gparted-6-efs</b> (in <code>/src3/KVM/bin</code>) and specify 
<code>/src4/ceph/Router/MyRouter.img</code> as its argument and use <b>gparted</b> 
command to partition <code>/dev/sdb</code> (1) First partition 488M, ext2, (2) 
second partition 3096M, ext4, (3) third partition 512M, swap.  I always got 513M for 
3rd partition.  Also turn on the boot flag for the first partition.  Apparently, 
first 1MB is reserved for MBR, not used.  I asked for 488M, only got 487M and the 
second partition (/) started at sector 999424, the correct offset to use 
<b>Config-Kvm</b> shell script.
<P> When asking for partitioning hard disk, choose skip and specify installing the 
root on sda2.  For everything else, just accept default.  Otherwise, vyatta just 
ignore whatever you specify.  When seeing "Done!", at system prompt, type
<PRE>
 $ poweroff 
</PRE>
<P> Booting image: 
<PRE>
$ kvm -hda MyRouter.img
</PRE>
<PRE>
 # login via vyatta and enter your new password.
 $ df 
 $ ls -l  
 $ ls -l / 
 $ ls -l /boot 
 $ more /etc/mtab 
 $ more /etc/fstab 
 $ ls -l /dev/sda1
 $ ls -l /opt/vyatta
 $ ls -l /opt/vyatta/bin 
 $ /sbin/ifconfig -a
 $ ls -l /etc/network  
 $ more /etc/network/interfaces  
 . 
 . 
 . 
auto lo 
iface lo inet loopback
 $ poweroff 
</PRE>
<P> We then create a Router with two NICs
<PRE> 
 $ cp MyRouter.img MyRouter-Template.img
 $ kvm -hda MyRouter-Template.img
 # MyRouter-Template.img is OK, poweroff.  It's a Template, we don't use it.
 $ Config-Kvm ../Router/MyRouter.img MyRouter 192.168.0.2 eth0 11
 $ start-MyRouter-11
 # From MyRouter console, "sudo adduser --home /home/hsu -shell /bin/bash hsu"
 # sudo chown hsu:hsu /home/hsu  ;; sudo without passwd, security concern.
 # Somehow, I didn't get proper /home/hsu directory.  I need to create and chown 
 # manually.  Then Config-Kvm ...... again, so that the recover70rules executable 
 # can be copied to /home/hsu and we can get rid of eth1, the wrong ethernet device.
 # After running recover70rules, still only get eth3, no eth0 and eth1.  Need to 
 # edit /opt/vyatta/etc/config/config.boot file.  The mac addresses of eth0 and eth1 
 # must match the ones we gave online when booting kvm -hda MyRouter.img.
</PRE>
<P> For ethernet and ssh to work correctly in vyatta router, we use nano to edit its 
config.boot file:
<PRE>
vyatta@vyatta:~$ ls -l /opt/vyatta/etc/config/config*
-rwxrwxr-x 1 root vyattacfg 1624 Sep 24 06:47 /opt/vyatta/etc/config/config.boot
-rwxrwxr-x 1 root vyattacfg 1440 Sep 24 02:40 /opt/vyatta/etc/config/config.boot.orig
$ diff /opt/vyatta/etc/config/config.boot /opt/vyatta/etc/config/config.boot.orig
41,46d40
< service {
<     ssh   {
<        port 22
<        protocol-version v2
<           }
< }
50c44
<         hw-id 1c:6f:65:4f:cc:8f
---
>         hw-id 52:54:00:12:34:56
55,60c49,54
< /*    ethernet eth2 {             */
< /*        hw-id 1c:6f:65:a8:8d:0f */
< /*    }                           */
< /*    ethernet eth3 {             */
< /*        hw-id 1c:6f:65:4f:cc:8f */
< /*    }                           */
---
>     ethernet eth2 {
>         hw-id 1c:6f:65:a8:8d:0f
>     }
>     ethernet eth3 {
>         hw-id 1c:6f:65:4f:cc:8f
>     }
</PRE>
<P> Also, on the start-MyRouter-11 shell script, we add second "-net nic" option 
  while booting vyatta.  Notice the mac addresses must coincide with the mac 
  addresses recorded in the <b>config.boot</b>  And we need to do the same for 
  the <b>start-MyRouter-11-AsDaemon</b> shell script.
<PRE>
$ diff start-MyRouter-11 start-MyRouter-11~
25c25
< kvm -net vde,vlan=0,sock=/src4/ceph/network-4556 -net nic,vlan=0,macaddr=1c:6f:65:4f:cc:8f -net nic,vlan=0,macaddr=1c:6f:65:e5:2f:3d -m 512M -monitor unix:/src4/ceph/network-4556/MonSock,server,nowait -hda ../Router/MyRouter.img &
---
> kvm -net vde,vlan=0,sock=/src4/ceph/network-4556 -net nic,vlan=0,macaddr=1c:6f:65:4f:cc:8f -m 512M -monitor unix:/src4/ceph/network-4556/MonSock,server,nowait -hda ../Router/MyRouter.img &
</PRE>
<P> With the above changes, poweroff and reboot vyatta, our router is ready for 
remote login.
<PRE>
# Although I add user hsu, and it seems the system has user hsu, but I can not 
# login as user hsu, wrong password.  And I was never asked to enter 
$ ssh -X vyatta@192.168.0.2
# Now, we get the two ethercards: eth0 and eth1 and the mac addresses got imbedded
# in their inet6 addresses. 
$ /sbin/ifconfig -a                                             
eth0      Link encap:Ethernet  HWaddr 1c:6f:65:4f:cc:8f  
          inet addr:192.168.0.2  Bcast:192.168.0.255  Mask:255.255.255.0
          inet6 addr: fe80::1e6f:65ff:fe4f:cc8f/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:261 errors:0 dropped:0 overruns:0 frame:0
          TX packets:194 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:23200 (22.6 KiB)  TX bytes:24733 (24.1 KiB)
          Interrupt:11 Base address:0xc000 
eth1      Link encap:Ethernet  HWaddr 1c:6f:65:e5:2f:3d  
          inet6 addr: fe80::1e6f:65ff:fee5:2f3d/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:1 errors:0 dropped:0 overruns:0 frame:0
          TX packets:4 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:46 (46.0 B)  TX bytes:408 (408.0 B)
          Interrupt:10 Base address:0xe000 
lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:16436  Metric:1
          RX packets:1422 errors:0 dropped:0 overruns:0 frame:0
          TX packets:1422 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:88532 (86.4 KiB)  TX bytes:88532 (86.4 KiB)
 $ diff /etc/apt/sources.list /etc/apt/sources.list.orig
2d1
< deb http://free.nchc.org.tw/debian wheezy main contrib
 $ ls -l /etc/resolv.conf*
-rw-r--r-- 1 root root 47 Sep 24 07:22 /etc/resolv.conf
-rw-r--r-- 1 root root  0 Sep 24 02:40 /etc/resolv.conf.orig
 $ diff /etc/resolv.conf /etc/resolv.conf.orig
1,3d0
< nameserver 168.95.192.1
< nameserver 168.95.1.1
< 
 $ sudo aptitude update;
 $ sudo aptitude safe-upgrade
 $ sudo aptitude clean
 $ sudo apt-get install emacs 
 # Bump, it seems vyatta is no debian at all!
 # In as, /bin/sh -> dash, /bin/sh.distrib -> bash
 # In vyatta, /bin/sh -> bash, /bin/sh.distrib -> dash
 # This causes dpkg reports error, and aptitude safe-upgrade fails.
 # After reboot, the contents of /etc/resolv.conf and /etc/apt/sources.list files 
 # are reseted to their original contents.  How could I modify them permanently?
 
 # To set correct root passwd
 $ sudo su root
 sudo: unable to resolve host vyatta
 # passwd root
 # As usual, enter password twice.
</PRE>
<P> It seems we need to set almost everything via configure command.  Otherwise, 
after reboot, we lost all the settings we had done in the previous session.
<PRE>
# Backup what we have done.
$ sudo cp /opt/vyatta/etc/config/config.boot /opt/vyatta/etc/config/config.boot-09-24-2012
# PATH=.:/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin
$ which configure # No where to be found
$ configure # Everybody can execute this command?
vyatta@vyatta:~$ configure
[edit]
vyatta@vyatta# which configure
[edit]
vyatta@vyatta# set system host-name MyRouter
[edit]
vyatta@vyatta# set interfaces ethernet eth0 address 192.168.0.2/24
sh: 1: Syntax error: "(" unexpected
sh: 1: Syntax error: "(" unexpected
[edit]
vyatta@vyatta# set interfaces ethernet eth0 address 192.168.0.2/24
sh: 1: Syntax error: "(" unexpected
sh: 1: Syntax error: "(" unexpected
  Configuration path: [interfaces ethernet eth0 address 192.168.0.2/24] already exists
[edit]
vyatta@vyatta# set interfaces ethernet eth1 address 192.168.1.1/24
sh: 1: Syntax error: "(" unexpected
sh: 1: Syntax error: "(" unexpected
[edit]
vyatta@vyatta# set system gateway-address 192.168.1.1
[edit]
vyatta@vyatta# set system name-server 168.95.192.1
[edit]
vyatta@vyatta# set system name-server 168.95.1.1
[edit]
vyatta@vyatta# show system name-server 
+name-server 168.95.192.1
+name-server 168.95.1.1
[edit]
vyatta@vyatta# set system login user hsu
[edit]
vyatta@vyatta# set system login user hsu authentication plaintext-password ----
[edit]
vyatta@vyatta# set system login user hsu level admin
sh: 1: Syntax error: "(" unexpected
[edit]
vyatta@vyatta# commit
[ system host-name MyRouter ]
sudo: unable to resolve host vyatta
[ interfaces ethernet eth1 address 192.168.1.1/24 ]
sudo: unable to resolve host MyRouter
[ interfaces ethernet eth0 address 192.168.0.2/24 ]
sudo: unable to resolve host MyRouter
RTNETLINK answers: File exists
[ system login ]
sudo: unable to resolve host MyRouter
[ system name-server 168.95.192.1 ]
sudo: unable to resolve host MyRouter
[ system name-server 168.95.1.1 ]
sudo: unable to resolve host MyRouter
Commit failed
sudo: unable to resolve host MyRouter
sudo: unable to resolve host MyRouter
[edit]
vyatta@vyatta# save
Warning: you have uncommitted changes that will not be saved.
sudo: unable to resolve host MyRouter
Saving configuration to '/config/config.boot'...
Done
[edit]
vyatta@vyatta# exit
Cannot exit: configuration modified.
Use 'exit discard' to discard the changes and exit.
[edit]
vyatta@vyatta# exit discard
exit
$ diff /opt/vyatta/etc/config/config.boot /opt/vyatta/etc/config/config.boot-09-24-2012
1,23d0
< interfaces {
<     ethernet eth0 {
<         duplex auto
<         hw-id 1c:6f:65:4f:cc:8f
<         smp_affinity auto
<         speed auto
<     }
<     ethernet eth1 {
<         address 192.168.1.1/24
<         duplex auto
<         hw-id 1c:6f:65:e5:2f:3d
<         smp_affinity auto
<         speed auto
<     }
<     loopback lo {
<     }
< }
< service {
<     ssh {
<         port 22
<         protocol-version v2
<     }
< }
25,29d1
<     config-management {
<         commit-revisions 20
<     }
<     gateway-address 192.168.1.1
<     host-name MyRouter
31,37d2
<         user hsu {
<             authentication {
<                 encrypted-password $1$HqUAvE5Z$xvUSwx7JHivpFMsxi3u6C/
<                 plaintext-password ""
<             }
<             level admin
<         }
40c5
<                 encrypted-password $1$w4SHcSLk$EC3uunhRpoMQb0k3MWz4o1
---
>                 encrypted-password "$1$w4SHcSLk$EC3uunhRpoMQb0k3MWz4o1"
45,54d9
<     name-server 168.95.192.1
<     name-server 168.95.1.1
<     ntp {
<         server 0.vyatta.pool.ntp.org {
<         }
<         server 1.vyatta.pool.ntp.org {
<         }
<         server 2.vyatta.pool.ntp.org {
<         }
<     }
56d10
<         auto-sync 1
58,62c12,14
<             components main
<             distribution stable
<             password ""
<             url http://packages.vyatta.com/vyatta
<             username ""
---
>             distribution "stable"
>             components "main"
>             url "http://packages.vyatta.com/vyatta"
75c27,60
<     time-zone GMT
---
>     ntp {
>         server "0.vyatta.pool.ntp.org"
>         server "1.vyatta.pool.ntp.org"
>         server "2.vyatta.pool.ntp.org"
>     }
>     console {
>         device ttyS0 {
>             speed 9600
>         }
>     }
>     config-management {
>         commit-revisions 20
>     }
> }
> service {
>     ssh   {
>        port 22
>        protocol-version v2
>           }
> }
> interfaces {
>     loopback lo
>     ethernet eth0 {
>         hw-id 1c:6f:65:4f:cc:8f
>     }
>     ethernet eth1 {
>         hw-id 1c:6f:65:e5:2f:3d
>     }
> /*    ethernet eth2 {             */
> /*        hw-id 1c:6f:65:a8:8d:0f */
> /*    }                           */
> /*    ethernet eth3 {             */
> /*        hw-id 1c:6f:65:4f:cc:8f */
> /*    }                           */
77,78d61
< 
< 
80c63
< /* === vyatta-config-version: "nat@4:system@5:webgui@1:cluster@1:conntrack@1:dhcp-relay@1:webproxy@1:config-management@1:conntrack-sync@1:quagga@2:wanloadbalance@3:zone-policy@1:dhcp-server@4:firewall@5:ipsec@3:qos@1:content-inspection@3:vrrp@1" === */
---
> /* === vyatta-config-version: "zone-policy@1:config-management@1:wanloadbalance@3:cluster@1:dhcp-relay@1:nat@4:ipsec@3:webproxy@1:qos@1:content-inspection@3:conntrack@1:conntrack-sync@1:system@5:vrrp@1:firewall@5:webgui@1:quagga@2:dhcp-server@4" === */
</PRE>
<P> After reboot, I got working account hsu, I can ping eth1, I even can remote login 
192.168.1.1 (from 192.168.0.2, MyRouter, but not from 192.168.0.32, the amd-6 host), a 
new subnet.  Also from 192.168.1.1, now I can ssh to amd-op.  The unresolved problems 
are: Where is the <b>configure</b> command?  There are quite a few syntax error messges 
during configuration session.  We even failed on commit and save commands.  Can I trust 
this <b>configure</b> command?
<PRE>
hsu@MyRouter:~$ ssh -X hsu@192.168.1.1
hsu@192.168.1.1's password: 
Linux MyRouter 3.0.23-1-amd64-vyatta-virt #1 SMP Fri Mar 23 19:38:13 PDT 2012 x86_64
Welcome to Vyatta.
  .
  .
  .
hsu@MyRouter:~$ ping -c 3 192.168.0.2
  .
  .
  .
64 bytes from 192.168.0.2: icmp_req=3 ttl=64 time=0.049 ms
  .
3 packets transmitted, 3 received, 0% packet loss, time 1999ms
  .
hsu@MyRouter:~$ ping -c 3 192.168.0.32
  .
  .
  .
64 bytes from 192.168.0.32: icmp_req=3 ttl=64 time=0.422 ms
  .
3 packets transmitted, 3 received, 0% packet loss, time 2002ms
  .
hsu@MyRouter:~$ ssh -X hsu@140.120.7.41
  .
  .
  .
Last login: Mon Sep 24 21:43:17 2012 from 122-118-191-184.dynamic.hinet.net
hsu@amd-op:~$ 
</PRE>
<P> For the host 192.168.0.32 (amd-6) to be able to ssh to 192.168.1.1, we add 
192.168.0.2 as its gateway to 192.168.1.0 sunnet
<PRE>
$ ssh -X hsu@192.168.1.1
ssh: connect to host 192.168.1.1 port 22: Connection timed out
hsu@amd-6:~/inet$ man route
hsu@amd-6:~/inet$ route -n  # Original routing table
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.0.1     0.0.0.0         UG    0      0        0 eth0
192.168.0.0     0.0.0.0         255.255.255.0   U     0      0        0 eth0
192.168.0.2     0.0.0.0         255.255.255.255 UH    0      0        0 tap11
hsu@amd-6:~/inet$ sudo route add -net 192.168.1.0 netmask 255.255.255.0 gw 192.168.0.2 
[sudo] password for hsu: 
hsu@amd-6:~/inet$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.0.1     0.0.0.0         UG    0      0        0 eth0
192.168.0.0     0.0.0.0         255.255.255.0   U     0      0        0 eth0
192.168.0.2     0.0.0.0         255.255.255.255 UH    0      0        0 tap11
192.168.1.0     192.168.0.2     255.255.255.0   UG    0      0        0 tap11
# The following command delete 192.168.0.2 as a router for 192.168.1.0/24
# $ sudo route del -net 192.168.1.0 netmask 255.255.255.0 gw 192.168.0.2
hsu@amd-6:~/inet$ ssh -X hsu@192.168.1.1
The authenticity of host '192.168.1.1 (192.168.1.1)' can't be established.
RSA key fingerprint is 4e:6a:b5:5b:7e:56:af:15:28:3d:5f:e4:1f:f9:ff:90.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '192.168.1.1' (RSA) to the list of known hosts.
hsu@192.168.1.1's password: 
X11 forwarding request failed on channel 0
Linux MyRouter 3.0.23-1-amd64-vyatta-virt #1 SMP Fri Mar 23 19:38:13 PDT 2012 x86_64
Welcome to Vyatta.
This system is open-source software. The exact distribution terms for 
each module comprising the full system are described in the individual 
files in /usr/share/doc/*/copyright.
Last login: Thu Sep 27 09:59:04 2012 from 192.168.1.1
hsu@MyRouter:~$ 
</PRE>
<P> On another host 192.168.0.33 (ac00), we need to add 192.168.0.2 as its 
router/gateway to 192.168.1.0 subnet, too.
<PRE>
 $ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.0.1     0.0.0.0         UG    0      0        0 eth0
192.168.0.0     0.0.0.0         255.255.255.0   U     0      0        0 eth0
hsu@Amath-Client00:/src4/ceph/Doc$ ping -c 3 192.168.1.1
PING 192.168.1.1 (192.168.1.1) 56(84) bytes of data.
--- 192.168.1.1 ping statistics ---
3 packets transmitted, 0 received, 100% packet loss, time 2017ms
hsu@Amath-Client00:/src4/ceph/Doc$ sudo route add -net 192.168.1.0 netmask 255.255.255.0 gw 192.168.0.2
[sudo] password for hsu: 
hsu@Amath-Client00:/src4/ceph/Doc$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.0.1     0.0.0.0         UG    0      0        0 eth0
192.168.0.0     0.0.0.0         255.255.255.0   U     0      0        0 eth0
192.168.1.0     192.168.0.2     255.255.255.0   UG    0      0        0 eth0
hsu@Amath-Client00:/src4/ceph/Doc$ ping -c 3 192.168.1.1
PING 192.168.1.1 (192.168.1.1) 56(84) bytes of data.
64 bytes from 192.168.1.1: icmp_req=1 ttl=63 time=451 ms
64 bytes from 192.168.1.1: icmp_req=2 ttl=63 time=0.732 ms
64 bytes from 192.168.1.1: icmp_req=3 ttl=63 time=0.744 ms
--- 192.168.1.1 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2000ms
rtt min/avg/max/mdev = 0.732/150.871/451.137/212.320 ms
# The following command delete 192.168.0.2 as a router for 192.168.1.0/24
# $ sudo route del -net 192.168.1.0 netmask 255.255.255.0 gw 192.168.0.2
hsu@Amath-Client00:/src4/ceph/Doc$ ssh -X hsu@192.168.1.1
hsu@192.168.1.1's password: 
X11 forwarding request failed on channel 0
Linux MyRouter 3.0.23-1-amd64-vyatta-virt #1 SMP Fri Mar 23 19:38:13 PDT 2012 x86_64
Welcome to Vyatta.
This system is open-source software. The exact distribution terms for 
each module comprising the full system are described in the individual 
files in /usr/share/doc/*/copyright.
Last login: Thu Sep 27 05:24:57 2012 from 192.168.0.33
# We notice that "sudo dpkg-reconfigure tzdata" done this morning (09/27/2012) for
# setting time zone lost effect after system rebooting.  Need to set time zone via 
# configure command.
hsu@MyRouter:~$ date
Thu Sep 27 06:04:02 GMT 2012
hsu@MyRouter:~$ exit
logout
-bash: /vyatta-monitor-cleanup: No such file or directory
Connection to 192.168.1.1 closed.
</PRE>
<P> For ac00 (192.168.0.33) and amd-6 (192.168.0.32) to be able to reach the gateway 
(virtual) 192.168.1.1, we add 192.168.0.2 (vyatta virtual router) as the gateway for 
192.168.1.0/24 subnet.  But, this will route 192.168.1.32 via 192.168.0.2.  The two 
subnets are no longer independent!  By the way, without vyatta router, we can remote 
login amd6 from ac00 via 192.168.1.32 and then from amd-6 to amd-op.  So, we did't 
gain anything by providing gateway for 192.168.1.0/24 subnet.  Or, I did create a 
malfunctioning router?  The following command helps us analyze packet traffics:
<a href="http://www.wains.be/pub/networking/tcpdump_advanced_filters.txt" 
target="newwindow">tcpdump advanced filters</a>
<PRE>
hsu@Amath-Client00:/src4/ceph/Doc$ ssh -X hsu@192.168.1.32
hsu@192.168.1.32's password: 
      .  
      .  
      .  
Last login: Sat Oct  6 13:54:14 2012 from amath-client00
amd-6:~$ xs amd-op
hsu@amd-op's password: 
      .  
      .  
      .  
Last login: Sat Oct  6 13:52:02 2012 from 122-118-176-243.dynamic.hinet.net
hsu@amd-op:~$ 
</PRE>
<LI><a name="KvmWith2Nics">Setup of Kvm with 2 Nics and 2 Taps</a>
<P> For IP path redundancy, we need some of our VMs to be accessible via two different 
subnets.  Of course, our physical host must have at least two ethernet cards and we can 
reach it via two different subnets, say 192.168.0.0/24 and 192.168.1.0/24.  In the 
following scenario, 192.168.0.0/24 is the public subnet, 192.168.1.0/24 is the private 
subnet, i.e. we use this subnet to achieve higher bandwidth and less interrupt.
<PRE>
 $ cd /src4/ceph/clients
 $ cp Debian-Eth1.img Debian-2Nics.img
 $ cd ../bin  
 $ Config-Kvm ../clients/Debian-2Nics.img Deb2Nics 192.168.1.253 eth1 253 
 # Manually add tun/tap for eth0:  eth0 communicates with host via tap243.  And we 
 # would like eth0 and eth1 to be on vlan0 and vlan1, two different switches.  Also,
 # we fake the MAC address of eth1 by subtract 10 from the last three hexadecimal 
 # digits of eth0.  Recall that the MAC address of eth0 is also a facked one!
 $ diff start-Deb2Nics-253-AsDaemon start-Deb2Nics-253-AsDaemon.orig
17,22d16
< #################################################################################
< sudo tunctl -u hsu -t tap243
< sudo ifconfig tap243 192.168.0.33 netmask 255.255.255.255 up
< sudo iptables --table nat -A POSTROUTING --out-interface eth0 -j MASQUERADE
< sudo iptables -A FORWARD --in-interface tap243 -j ACCEPT
< #################################################################################
28,31d21
< #################################################################################
< sudo arp -Ds 192.168.0.253 eth0 pub
< sudo route add -host 192.168.0.253 dev tap243
< #################################################################################
34,36d23
< #################################################################################
< vde_switch -tap tap243 -mod 644 -sock=/src4/ceph/network-3610 -mgmt /src4/ceph/network-3610/vde_switch.mgmt -daemon </dev/null >/dev/null
< #################################################################################
38c25
< screen -S Deb2Nics -d -m kvm  -net vde,vlan=0,sock=/src4/ceph/network-3610 -net nic,vlan=0,macaddr=00:25:90:d5:c6:42 -net vde,vlan=1,sock=/src4/ceph/network-3620 -net nic,vlan=1,macaddr=00:25:90:c5:b6:32 -m 512M -monitor unix:/src4/ceph/network-3620/MonSock,server,nowait -curses -hda ../clients/Debian-2Nics.img &
---
> screen -S Deb2Nics -d -m kvm -net vde,vlan=0,sock=/src4/ceph/network-3620 -net nic,vlan=0,macaddr=00:25:90:d5:c6:42 -m 512M -monitor unix:/src4/ceph/network-3620/MonSock,server,nowait -curses -hda ../clients/Debian-2Nics.img &
</PRE>
<LI> Multipath RBD via iSCSI 
<P> References:
  <TABLE>
    <TR><TD>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <TD><a href="http://en.wikipedia.org/wiki/ISCSI" 
   target="newwindow">iSCSI Introduction Wiki</a>&nbsp;&nbsp;&nbsp;&nbsp;
        <TD><a href="VirtualStorageAndUsbHdd.html#CephiScsi" target="newwindow">Ceph 
   ISCSI Wiki</a>&nbsp;&nbsp;&nbsp;&nbsp;
        <TD><a href="http://pjack1981.blogspot.tw/2011/09/export-ceph-rbd-with-iscsi.html" 
   target="newwindow">Rbd via ISCSI</a>&nbsp;&nbsp;&nbsp;&nbsp;
    <TR><TD>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <TD><a href="http://wiki.debian.org/SAN/iSCSI" 
   target="newwindow">Debian iSCSI Wiki</a>&nbsp;&nbsp;&nbsp;&nbsp;
        <TD><a href="http://www.howtoforge.com/using-iscsi-on-debian-squeeze-initiator-and-target" 
   target="newwindow">Debian iSCSI</a>&nbsp;&nbsp;&nbsp;&nbsp;
        <TD><a href="http://christophe.varoqui.free.fr/refbook.html" 
   target="newwindow">MultiPath</a>&nbsp;&nbsp;&nbsp;&nbsp;
    <TR><TD>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <TD>
        <TD>
  </TABLE>
</OL>
