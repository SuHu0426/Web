<HTML>
<HEAD>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <TITLE>Lab 1 Assignment </TITLE>
  <link type="text/css" rel="stylesheet" href="style.css" />
</HEAD>
<BODY>
<h1>Lab 1: Assignment</h1>
<h2>實驗描述</h2>
<p>利用 template 複製方式來建立兩部 UML 虛擬機器與兩部 KVM 虛擬機器。
<p>Introduction of Cloud Computing 班之 IP 分配表如下：
<table border="1">
<tr><th>組別<th>姓名 1<th>姓名 2<th>IP<th>UML<th>KVM<th>Completion time
<tr align="center"><td>01<td>江敏宏<td>吳書瑋<td>192.168.0.51 ~ 192.168.0.54<td>OK<td>OK<td>before Thu Oct 28
<tr align="center"><td>02<td>黃彥儒<td>張順堯<td>192.168.0.55 ~ 192.168.0.58<td>OK<td>OK<td>Thu Oct 28
<tr align="center"><td>03<td>羅志誠<td>劉家銘<td>192.168.0.59 ~ 192.168.0.62<td>OK<td>OK<td>before Thu Oct 28
<tr align="center"><td>04<td>張延詮<td>施依君<td>192.168.0.63 ~ 192.168.0.66<td>OK<td>OK<td>before Thu Oct 28
<tr align="center"><td>05<td>陳威勝<td>何易宸<td>192.168.0.67 ~ 192.168.0.70<td>OK<td>OK<td>before Thu Oct 28
<tr align="center"><td>06<td>許富翔<td>侯智皓<td>192.168.0.71 ~ 192.168.0.74<td>OK<td>OK<td>before Thu Oct 28
<tr align="center"><td>07<td>朱信昱<td>郭秉仁<td>192.168.0.75 ~ 192.168.0.78<td>OK<td>OK<td>before Thu Oct 28
<tr align="center"><td>08<td>許芳甄<td>江振綱<td>192.168.0.79 ~ 192.168.0.82<td>OK<td>OK<td>before Thu Oct 28
<tr align="center"><td>09<td>陳家康<td>張天釋<td>192.168.0.83 ~ 192.168.0.86<td>OK<td>OK<td>before Thu Oct 28
<tr align="center"><td>10<td>李旭峰<td>張峰嘉<td>192.168.0.87 ~ 192.168.0.90<td>OK<td>OK<td>before Thu Oct 28
<tr align="center"><td>11<td>高誌遠<td>朱逸勤<td>192.168.0.91 ~ 192.168.0.94<td>OK<td>OK<td>before Thu Oct 28
<tr align="center"><td>12<td>吳東烈<td>張簡宏名<td>192.168.0.95 ~ 192.168.0.98<td>OK<td>OK<td>before Thu Oct 28
<tr align="center"><td>13<td>王郁筑<td>江欣怡<td>192.168.0.99 ~ 192.168.0.102<td>OK<td>OK<td>before Thu Oct 28
<tr align="center"><td>14<td>侯柏丞<td>蕭中一<td>192.168.0.103 ~ 192.168.0.106<td>OK<td>OK<td>before Thu Oct 28
<tr align="center"><td>15<td>賴俊佑<td>Latha<td>192.168.0.107 ~ 192.168.0.110<td>OK<td>OK<td>before Thu Oct 28
<tr align="center"><td>16<td>鄭有成<td>林逸豪<td>192.168.0.111 ~ 192.168.0.114<td>OK<td>OK<td>before Thu Oct 28
<tr align="center"><td>17<td>林正浩<td>陳俞孝<td>192.168.0.115 ~ 192.168.0.118<td>OK<td>OK<td>before Thu Oct 28
<tr align="center"><td>18<td>陳孟緯<td>張立田<td>192.168.0.119 ~ 192.168.0.122<td>OK<td>OK<td>before Thu Oct 28
<tr align="center"><td>19<td>測試<td>範例1<td>192.168.0.123 ~ 192.168.0.126<td><td><td>
</table>
<p>帳號為 csie01 至 csie20，1 至 9 組請補 0。
<p>01 ~ 10 組，使用 CSIE-Cloud03 機器。<br>
11 ~ 20 組，使用 CSIE-Cloud04 機器。
<p>多開 VM 時需注意 IP、hostname、TAP-No 是否重複，分配原則如下(以 csie20 為例)：<br>
<table border="0">
<tr><th>hostname<th>IP<th>TAP-No<th>Root Filesystem
<tr align="center"><td>csie20-uml1<td>192.168.0.127<td>csie20-uml1<td>uml1.ext3
<tr align="center"><td>csie20-uml2<td>192.168.0.128<td>csie20-uml2<td>uml2.ext3
<tr align="center"><td>csie20-kvm1<td>192.168.0.129<td>csie20-kvm1<td>kvm1.img
<tr align="center"><td>csie20-kvm2<td>192.168.0.130<td>csie20-kvm2<td>kvm2.img
</table>
<p>網路專題班 IP 分配表如下：
<table border="1">
<tr><th>組別<th>姓名<th>IP<th>UML<th>KVM<th>Completion time
<tr align="center"><td>01<td>江敏宏<td>192.168.0.131 ~ 192.168.0.134<td>白天<td>白天<td>白天
<tr align="center"><td>02<td>李滄智<td>192.168.0.135 ~ 192.168.0.138<td>OK<td>OK<td>Tue Nov 03
<tr align="center"><td>03<td>蔡政信<td>192.168.0.139 ~ 192.168.0.142<td>OK<td>OK<td>Wed Nov 02
<tr align="center"><td>04<td>歐陽方<td>192.168.0.143 ~ 192.168.0.146<td>OK<td>OK<td>Fri Oct 30
<tr align="center"><td>05<td>劉政鋊<td>192.168.0.147 ~ 192.168.0.150<td>OK<td>OK<td>Mon Oct 31
<tr align="center"><td>06<td>紀鈞祐<td>192.168.0.151 ~ 192.168.0.154<td>OK<td>OK<td>Fri Oct 30
<tr align="center"><td>07<td>陳家銘<td>192.168.0.155 ~ 192.168.0.158<td>OK<td>OK<td>Fri Oct 30
<tr align="center"><td>08<td>潘榮長<td>192.168.0.159 ~ 192.168.0.162<td>OK<td>OK<td>Thu Nov 03
<tr align="center"><td>09<td>林哲暉<td>192.168.0.163 ~ 192.168.0.166<td>OK<td>OK<td>Sun Oct 30
<tr align="center"><td>10<td>童永昇<td>192.168.0.167 ~ 192.168.0.170<td>OK<td>OK<td>Mon Oct 31
<tr align="center"><td>11<td>謝旻杰<td>192.168.0.171 ~ 192.168.0.174<td>OK<td>OK<td>Sat Oct 29
<tr align="center"><td>12<td>吳帥鋒<td>192.168.0.175 ~ 192.168.0.178<td>OK<td>OK<td>Sat Oct 29
<tr align="center"><td>13<td>陳盈利<td>192.168.0.179 ~ 192.168.0.182<td>OK<td>OK<td>Tue Nov 01
<tr align="center"><td>14<td>林冠宇<td>192.168.0.183 ~ 192.168.0.186<td>OK<td>OK<td>Sat Oct 29
<tr align="center"><td>15<td>黃大哲<td>192.168.0.187 ~ 192.168.0.190<td>OK<td>OK<td>Thu Nov 03
<tr align="center"><td>16<td>陳智偉<td>192.168.0.191 ~ 192.168.0.194<td>OK<td>OK<td>Sun Oct 30
<tr align="center"><td>17<td>林平傑<td>192.168.0.195 ~ 192.168.0.198<td>OK<td>OK<td>Sat Nov 06
<tr align="center"><td>18<td>蕭婉婷<td>192.168.0.199 ~ 192.168.0.202<td>OK<td>OK<td>Sat Nov 06
<tr align="center"><td>19<td>莊銘翰<td>192.168.0.203 ~ 192.168.0.206<td> <td> <td>
<tr align="center"><td>20<td>說明組<td>192.168.0.207 ~ 192.168.0.210<td><td><td>
</table>
<p>帳號為 ctsp01 至 ctsp20，1 至 9 組請補 0。
<p>01 ~ 10 組，使用 CSIE-Cloud01 機器。<br>
11 ~ 20 組，使用 CSIE-Cloud02 機器。
<p>多開 VM 時需注意 IP、hostname、TAP-No 是否重複，分配原則如下(以 ctsp20 為例)：<br>
<table border="0">
<tr><th>hostname<th>IP<th>TAP-No<th>Root Filesystem
<tr align="center"><td>ctsp20-uml1<td>192.168.0.207<td>ctsp20-uml1<td>uml1.ext3
<tr align="center"><td>ctsp20-uml2<td>192.168.0.208<td>ctsp20-uml2<td>uml2.ext3
<tr align="center"><td>ctsp20-kvm1<td>192.168.0.209<td>ctsp20-kvm1<td>kvm1.img
<tr align="center"><td>ctsp20-kvm2<td>192.168.0.210<td>ctsp20-kvm2<td>kvm2.img
</table>
<p>複製 UML template 範例，請將目錄改為自己的工作目錄。
<pre> $ cd /src3/UML-csie20
 $ cp /src3/UML/DebSqz-UltraLight.ext3.gz uml1.ext3.gz
 $ cp /src3/UML/DebSqz-UltraLight.ext3.gz uml2.ext3.gz
</pre>
<p>複製 KVM template 範例，請將目錄改為自己的工作目錄。
<pre> $ cd /src4/KVM-csie20/img
 $ cp /src4/KVM/Resize/Debian-Mini.img.gz kvm1.img.gz
 $ cp /src4/KVM/Resize/Debian-Mini.img.gz kvm2.img.gz
</pre>
<!-- ==================== Q&A ==================== -->
<h1>Q & A</h1>
<p>Q: 請問要怎麼檢查哪些沒關?
<p>A:
<pre> $ ps aux | grep csie10
</pre>可以查詢自己帳號所執行的所有指令，看看是不是某些程式沒正常關閉<br>
例如
<code>
csie10   26332  0.0  0.0   6160   472 ?        Ss   03:25   0:00 vde_switch -tap tapcsie10-kvm1 -mod 644 -sock=/src4/KVM-csie10/network-6938 -mgmt /src4/KVM-csie10/network-6938/vde_switch.mgmt -daemon
</code>
接著使用下列指令將其關閉。
<pre> $ sudo kill -9 26332
</pre>
然後重新執行 stop-* script 確定該關的東西都有關閉
<!-- ==================== 注意 ==================== -->
<h1><font color="red">注意: </font></h1>
<OL>
<li>評分完畢組別之機器請將其關閉，若尚未檢查到之機器，請將其維持上線。<br>
請同時開啟兩台 VM 檢查，以確保 VM 可同時上線不會衝突。<br><br>
<li>抱歉，由於我的疏失，造成大家複製了大量的 filesystem template($ cp /backup/KVM-tool/Resize/Resize-*.tgz Resize)，<br>
造成 /src4 空間銳減。因此，請大家使用以下指令清空各自目錄中之 Resize 目錄。
<pre>  $ rm /src4/KVM-ctsp${Tn}/Resize/*.img
</pre>
爾後請從 /src4/KVM/Resize/ 中複製相關之樣板至各自目錄中 img 目錄，如前段 (複製 KVM template) 所述。<br><br>
<li>Private LAN 已建置完成，所以不再使用 eth0:0 之虛擬網卡，請改用 eth1。<br><br>
<li>若您使用上課時所安裝的 shell script，發現設定完找不到 recover70rules 此 scrip，請 cp /backup/KVM-tool/KVM-tool-*.tgz 到工作目錄並重新 tar 開 (解壓縮)。<br><br>
</OL>
<p>下為具體<b>參考</b>步驟，網路專題班同學，請自行取代帳號名稱(csie -> ctsp)：
<OL>
  <h3><li>連線方式 (白天班)</h3>
<p>01 ~ 10 組先登入 CSIE-Cloud01 再登入 CSIE-Cloud03。
<pre> $ ssh -X cloud@CSIE-Cloud01 # Replace CSIE-Cloud01 by IP
 cloud@CSIE-Cloud01:~$ ssh -X csie20@cloud03
</pre>
<p>11 ~ 20 組先登入 CSIE-Cloud02 再登入 CSIE-Cloud04。
<pre> $ ssh -X cloud@CSIE-Cloud02 # Replace CSIE-Cloud02 by IP
 cloud@CSIE-Cloud02:~$ ssh -X csie20@cloud04
</pre>
 
  <h3><li>建立 UML 虛擬機器</h3>
<ol>
  <li> Prepare for UML.
 <p> Check whether you got linux.uml and its related module. <br>
      <b>註: 下列幾步已經由助教完成.</b> 
<pre>  # The lines leading by "#" sign need not to be done.
  # $ sudo apt-get install uml-utilities vde2 screen
  # $ ls -l /usr/local/lib/uml 
<code>  # If you get No such file or directory, create it.
</code>  # $ sudo mkdir /usr/local/lib/uml 
  # $ sudo chown cloud:cloud /usr/local/lib/uml 
  # $ cd /usr/local/lib/uml 
  # $ scp hsu@as:/backup/tmp/uml-2011-08-01.tgz .
  # $ tar -zxvf uml-2011-08-01.tgz 
  # $ ls -l 
  # $ rm uml-2011-08-01.tgz 
<code>  # Copy UML kernel to PATH.
</code>  # $ sudo cp linux.uml /usr/local/bin
</pre>
  <li> Now, get template and related tools from our server
<pre>  $ Tn={YOUR_TEAM_NUMBER}
<code>  # 建立個人專屬目錄
</code>  $ sudo mkdir /src3/UML-csie${Tn}
  $ sudo chown csie${Tn}:csie${Tn} /src3/UML-csie${Tn}
  $ cd /src3/UML-csie${Tn} 
<code>  # 確認目錄是乾淨的
</code>  $ rm -rf /src3/UML-csie${Tn}/*
<code>  # 複製相關檔案至目錄中
</code>  $ cp -r /src3/UML/* . 
  $ ln Config-UML-Rfs Config-UML-Rfs-UmlSwitch 
  $ gunzip DebSqz-UltraLight.ext3.gz 
<code>  # 建立掛載點
</code>  $ sudo mkdir /mnt/csie${Tn}
  $ sudo mount -o loop DebSqz-UltraLight.ext3 /mnt/csie${Tn} 
<code>  # In another xterm login CSIE-Cloud again.
  # 開啟新的終端機執行下列指令，以避免經常性路徑切換。
  # 先將舊版 modules 移除，再從系統中複製到 VM 之相對應目錄中。
</code>  $ sudo rm -rf /mnt/csie${Tn}/lib/modules/* 
  $ cd /usr/local/lib/uml/lib/modules/ 
<code> # 請以 man 指令查詢說明
  $ man find
  $ man cpio
</code>  $ find . -print | sudo cpio -pdm /mnt/csie${Tn}/lib/modules/ 
  $ sync; sync 
  $ ls -l /mnt/csie${Tn}/lib/modules 
<code>  # Back to the original xterm 
  # 回到先前終端機中，卸載 root filesystem。
</code>  $ sudo umount /mnt/csie${Tn} 
</pre>
  </li><li> Configure and Test VM
<pre>  $ Config-UML-Rfs
<code>./Config-UML-Rfs root-fs-pathname uml-hostname UML-IP Ether-Card [TAP-No]
    TAP-No is optional, if need tap to be different from tap0.
  # hostname, VMIP, and TAP-No 請參考分配表。
</code>  $ Config-UML-Rfs ./DebSqz-UltraLight.ext3 ${hostname} ${VMIP} eth1 ${TAP-No}
<code>  # Hopefully, you get startUML, startUMLAsDaemon, stop-uml-restore-lan, 3 files.
  # The first script is for starting UML in foreground.  For system repairing
  # or maintenance reasons, from time to time, we need to start our VMs in 
  # the foreground.  For common usage, whether it be special server, compute
  # slave in some high performance cluster, usually, we start it as a daemon.
  # After halting a VM, it is our job to restore the system network state to 
  # its origin. Otherwise, next time, we will have hard time to get our VM's
  # virtual network working again.
  # Nowadays, the smallest graphical system needs at least 1GB.  Otherwise, 
  # it would be almost impossible to upgrade system safely.  How I hate it!
</code>  $ startUML-${hostname}
<code>  # login UML as cloud, and in UML
　# 請再三確定您在虛擬機器中，才下達下列指令！
</code>  $ su 
<code>  ;; shutdown uml 
</code>  # halt 
<code>  # We need to restore lan to its original state 
  # You see tap${TAP-No}, a virtual ethernet card
</code>  $ ifconfig -a
  $ stop-uml-restore-lan-${TAP-No}
<code>  # The tap${TAP-No} virtual ethernet card should disappear 
</code>  $ ifconfig -a 
<code>  # 將 UML 開啟在背景中 
</code>  $ startUML-${hostname}-AsDaemon  
<code>  # 確認 linux.uml 有在執行
</code>  $ ps aux | grep linux.uml | grep ${hostname}
<code>  # Wait for two or three minutes 
  # check whether you can login or not.
</code>  $ ssh -X cloud@${VMIP}
<code>  # After login, type exit.
</code>  $ exit</pre>
     </li></ol>
   </li>
<h3><li>建立 Kernel-based virtual machine, KVM, 虛擬機器.</h3>
<p>  The procedures involved for starting and halting VMs are rather
   complicated, but the command lines need to accomplish the whole job
   are quite similar.  If we are going to key-in all the commands by
   hands, it is rather error-prone.  Our biggest contribution is that
   we unify the whole process, from starting to halting UML or KVM VMs,
   via rather similar procedures, such as startVM in foreground, startVM
   as daemon, stop-VM-restore-lan. And we write a shell script to prepare
   the above 3 scripts automatically.
<br><br>
<ol>
  <li> Prepare for KVM.
<p>Check hardware virtualization support, and then install KVM.<br>
<b>註: 下列幾步已經由助教完成.</b>
<pre>  $ egrep '(vmx|svm)' --color=always /proc/cpuinfo # Hardware Assisted Virtualization
  # $ sudo aptitude update
  # $ sudo aptitude install kvm qemu-utils vde2 socat
  # $ sudo modprobe kvm_amd
<code>  ## Reboot
</code>  # $ sudo adduser csie${Tn} kvm
</pre>
  <li> 建立工作環境
<pre>  $ Tn={YOUR_TEAM_NUMBER}
  $ sudo mkdir /src4/KVM-csie${Tn}
  $ sudo chown csie${Tn}:csie${Tn} /src4/KVM-csie${Tn}
  $ cd /src4/KVM-csie${Tn}; mkdir Resize img
  $ cp /backup/KVM-tool/KVM-tool-*.tgz .
<code>  # 系統中存有一份即可，不需要每個人都複製檔案系統樣板！
  # $ cp /backup/KVM-tool/Resize/Resize-*.tgz Resize
  # $ cd Resize; tar -zxvf Resize-*.tgz; rm Resize-*.tgz
  # $ cd ..;</code>  $ tar -zxvf KVM-tool-*.tgz; rm KVM-tool-*.tgz
</pre>
  <li>Create KVM root-filesystem. <b>(skip this step!)</b>
<pre>  $ cd img
  $ qemu-img create DebSqz-Mini.img 2G
  $ kvm -cdrom ../Resize/debian-6.0.2.1-amd64-netinst.iso DebSqz-Mini.img -m 512M
</pre>
Partition the image as: /boot and /
  <p> Give 512M to boot, turn on its boot flag, use ext2 filesystem format. The rest
      for / partition, use ext4  filesystem format. Install only the minimal packages
      offered by the installation menu, but must include openssh-server, since we
      need to login the VM via <b>ssh</b>.</p>
<li>Copy templates, and uncompress them.
<pre> $ cd img
 $ cp /src4/KVM/Resize/Debian-Mini.img.gz kvm1.img.gz
 $ cp /src4/KVM/Resize/Debian-Mini.img.gz kvm2.img.gz
 $ gunzip kvm1.img.gz
 $ gunzip kvm2.img.gz
</pre>
  <li>Configure VM
<pre>  $ cd ../bin
  $ ls -lia Config-Kvm*
<code>  # Notice the three files are the same. When invoke them by different names,
  # we can configure image files for different OSes.
  # Also, as far as I remembered, newer Debian VM need to run the command
  # ./recover70rules. Otherwise, next time eth0 is no longer available.
</code>  $ ./Config-Kvm
<code>  # We use this script to configure ../Resize/Debian-Gparted.img.
  # hostname, VMIP, and TAP-No 請參考分配表。
</code>  $ Config-Kvm ../img/DebSqz-Mini.img ${hostname} ${VMIP} eth1 ${TAP-No}
  $ start-${hostname}-${TAP-No}
<code>  # login KVM as cloud, and in KVM
　# 請再三確定您在虛擬機器中，才下達下列指令！
</code>  $ su
  # ./recover70rules
  # halt
  $ stop-${hostname}-restore-lan-${TAP-No}
<code> 重新將 VM 上線，開啟在背景中。
</code>  $ start-${hostname}-${TAP-No}-AsDaemon
  $ ssh -X cloud@${VMIP}
<code>  ;; After login, type exit.
</code>  $ exit
</pre></ol>
</ol>
<br><br><br>
</BODY>
</HTML>
